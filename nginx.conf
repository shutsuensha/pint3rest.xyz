server {
    listen 80;
    server_name pint3rest.xyz www.pint3rest.xyz;

    # –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name pint3rest.xyz www.pint3rest.xyz;

    client_max_body_size 100M;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/pint3rest.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pint3rest.xyz/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # HSTS (—É–ª—É—á—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è 6 –º–µ—Å—è—Ü–µ–≤)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # üîí –ó–∞—â–∏—Ç–∞ –æ—Ç Clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # üîí –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
    add_header X-XSS-Protection "1; mode=block" always;

    # üîí –ó–∞—â–∏—Ç–∞ –æ—Ç MIME-–∞—Ç–∞–∫
    add_header X-Content-Type-Options "nosniff" always;

    # üî• –í–∫–ª—é—á–∞–µ–º Gzip-—Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_min_length 1024;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml font/woff2;
    gzip_disable "msie6";
    gzip_proxied any;
    gzip_vary on;

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # –†–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏–∫–∏ (Vue.js)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri /index.html;
    }

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ API-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ FastAPI
    location /api/sse/ {
        proxy_pass http://fastapi-container:8000/sse/;

        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è SSE
        proxy_buffering off;
        proxy_set_header X-Accel-Buffering no;

        # –î–æ–ª–≥–∏–µ —Ç–∞–π–º–∞—É—Ç—ã ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∂–∏—Ç—å —á–∞—Å–∞–º–∏
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ HTTP –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ chunked encoding
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ REST API –Ω–∞ FastAPI
    location /api/ {
        proxy_pass http://fastapi-container:8000/;

        # –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è REST
        proxy_buffering on;

        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ REST-–∑–∞–ø—Ä–æ—Å–æ–≤
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;

        # –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    location /ws/ {
        proxy_pass http://fastapi-container:8000/;

        # WebSocket —Ç—Ä–µ–±—É–µ—Ç HTTP/1.1
        proxy_http_version 1.1;

        # –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–æ–ª–≥–∏—Ö WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    location /favicon.ico {
        proxy_pass http://fastapi-container:8000/api/favicon.ico;
    }

    location /prometheus/ {
        proxy_pass http://prometheus:9090;        # ‚Üê –ù–ï–¢ —Å–ª—ç—à–∞ –≤ –∫–æ–Ω—Ü–µ
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        auth_basic           "Restricted Access";
        auth_basic_user_file /etc/nginx/auth/.htpasswd;

        proxy_redirect off;                    # –æ—Ç–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
    }


    location /stub_status {
        stub_status;
        allow 127.0.0.1;
        allow 172.18.0.0/16;  # –ü–æ–¥—Å–µ—Ç—å Docker (–º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —á–µ—Ä–µ–∑ `docker network inspect`)
        deny all;
    }

    location /grafana/ {
        proxy_pass http://grafana:3000;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
    }


    location /loki/ {
        proxy_pass http://loki:3100/loki/;     # ‚Üê –ù–ï–¢ —Å–ª—ç—à–∞ –≤ –Ω–∞—á–∞–ª–µ –ø—É—Ç–∏ —É upstream, –Ω–æ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ü–µ URL
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        auth_basic           "Restricted Loki";
        auth_basic_user_file /etc/nginx/auth/.htpasswd;

        proxy_redirect off;                    # –æ—Ç–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
    }
}
